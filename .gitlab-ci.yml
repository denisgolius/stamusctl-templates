stages:
    - tests
    - docker
    - release

default:
  tags:
    - k8s-small

workflow:
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        - if: $CI_COMMIT_TAG
        - if: $CI_COMMIT_BRANCH == "main"

lint-commits:
    tags:
        - k8s-small
    image: registry.hub.docker.com/library/node:22-alpine
    stage: tests
    needs: []
    before_script:
        - apk add --no-cache git
        - npm install --save-dev @commitlint/config-conventional @commitlint/cli
    variables:
        GIT_DEPTH: 0
    script:
        - npx commitlint --from ${CI_MERGE_REQUEST_DIFF_BASE_SHA} --to ${CI_COMMIT_SHA}
    rules:
        - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'


tests:
    stage: docker
    image: docker:24.0.5
    variables:
        DOCKER_HOST: tcp://docker:2376
        DOCKER_TLS_CERTDIR: '/certs'
        DOCKER_TLS_VERIFY: 1
        DOCKER_CERT_PATH: '$DOCKER_TLS_CERTDIR/client'
    services:
        - docker:24.0.5-dind
    before_script:
        - until docker info; do sleep 1; done
    script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker build
            "${CI_PROJECT_DIR}/."
            -f "${CI_PROJECT_DIR}/Dockerfile"
            --build-arg "path=/tests"
            -t "${CI_REGISTRY_IMAGE}/tests:${CI_COMMIT_SHORT_SHA}"
            -t "${CI_REGISTRY_IMAGE}/tests:${CI_COMMIT_REF_NAME}"
        - docker push ${CI_REGISTRY_IMAGE}/tests:${CI_COMMIT_SHORT_SHA}
        - docker push ${CI_REGISTRY_IMAGE}/tests:${CI_COMMIT_REF_NAME}


clearndr:
    stage: docker
    image: docker:24.0.5
    variables:
        DOCKER_HOST: tcp://docker:2376
        DOCKER_TLS_CERTDIR: '/certs'
        DOCKER_TLS_VERIFY: 1
        DOCKER_CERT_PATH: '$DOCKER_TLS_CERTDIR/client'
    services:
        - docker:24.0.5-dind
    before_script:
        - until docker info; do sleep 1; done
    script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker build
            "${CI_PROJECT_DIR}/."
            -f "${CI_PROJECT_DIR}/Dockerfile"
            --build-arg "path=/clearndr"
            -t "${CI_REGISTRY_IMAGE}/clearndr:${CI_COMMIT_SHORT_SHA}"
            -t "${CI_REGISTRY_IMAGE}/clearndr:${CI_COMMIT_REF_NAME}"
        - docker push ${CI_REGISTRY_IMAGE}/clearndr:${CI_COMMIT_SHORT_SHA}
        - docker push ${CI_REGISTRY_IMAGE}/clearndr:${CI_COMMIT_REF_NAME}

release-to-github:
    stage: release
    image: bitnami/git
    rules:
        - if: $CI_COMMIT_BRANCH
    script:
        - git config --global user.email $GITLAB_USER_EMAIL
        - git config --global user.name $GITLAB_USER_NAME
        - git remote add github "https://$GITHUB_USERNAME:$GITHUB_PAT@github.com/StamusNetworks/stamusctl-templates.git"
        - git push -u --no-thin -f github HEAD:refs/heads/$CI_COMMIT_BRANCH

release-to-github-from-mr:
    stage: release
    image: bitnami/git
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    script:
        - git config --global user.email $GITLAB_USER_EMAIL
        - git config --global user.name $GITLAB_USER_NAME
        - git remote add github "https://$GITHUB_USERNAME:$GITHUB_PAT@github.com/StamusNetworks/stamusctl-templates.git"
        - git push -u --no-thin -f github HEAD:refs/heads/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME


create release with semantic-release:
    stage: release
    image: node:22
    before_script:
        - corepack enable
        - corepack prepare pnpm@latest --activate
        - pnpm config set store-dir .pnpm-store
    cache:
        key:
            files:
                - pnpm-lock.yaml
        paths:
            - .pnpm-store
    variables:
        GITLAB_TOKEN: $ACCESS_TOKEN
    script:
        - git config user.email $GITLAB_USER_EMAIL
        - git config user.name $GITLAB_USER_NAME
        - pnpm i
        - export NEXT_VERSION=$(pnpm run release --no-ci --dry-run | grep -oP 'The next release version is \K[0-9]+\.[0-9]+\.[0-9]+[-A-Za-z0-9.]+')
        - pnpm run release --no-ci
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        - if: $CI_COMMIT_BRANCH == "main"
