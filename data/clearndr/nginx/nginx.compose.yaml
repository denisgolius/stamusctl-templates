configs:
    nginx-config:
        file: nginx.conf
    nginx-selks-config:
        file: conf.d/selks6.conf

volumes:
    nginx-ssl:
        name: nginx-ssl-{{ .Release.seed }}

services:
	{{- if .Values.nginx.ssl.enabled }}
    {{- if not .Values.nginx.ssl.sslFolder }}
    ssl-keygen:
        image: nginx:1.27
        container_name: {{template "base-name" .}}-ssl-keygen-{{ .Release.seed }}
        command: [
            '/bin/bash',
            '-c',
            'if [ ! -e "/etc/nginx/ssl/scirius.crt" ]; then openssl req -verbose -new -nodes -x509 -subj "/C=FR/ST=IDF/L=Paris/O=Stamus/CN=SELKS" -days 3650 -keyout /etc/nginx/ssl/scirius.key -out /etc/nginx/ssl/scirius.crt -extensions v3_ca; fi;'
        ]
        restart: on-failure
        volumes:
            - nginx-ssl:/etc/nginx/ssl
        networks:
            network:
    {{- end }}
    {{- end }}

    nginx:
        image: nginx:1.27
        container_name: {{template "base-name" .}}-nginx-{{ .Release.seed }}
        command: ['${NGINX_EXEC:-nginx}', '-g', 'daemon off;']
        configs:
            - source: nginx-config
              target: /etc/nginx/nginx.conf
            - source: nginx-selks-config
              target: /etc/nginx/conf.d/selks6.conf
        restart: {{ .Values.globals.restartmode | default "unless-stopped" }}
        healthcheck:
            test: ['CMD', 'service', 'nginx', 'status']
            interval: 10s
            timeout: 2s
            retries: 5
        volumes:
            - scirius-static:/static/:ro
        	{{- if .Values.nginx.ssl.enabled }}
            {{- if .Values.nginx.ssl.sslFolder }}
            - {{ .Values.nginx.ssl.sslFolder }}:/etc/nginx/ssl:ro
            {{- else }}
            - nginx-ssl:/etc/nginx/ssl:ro
            {{- end }}
            {{- end }}
        depends_on:
        	{{- if and .Values.nginx.ssl.enabled (not .Values.nginx.ssl.sslFolder) }}
            ssl-keygen:
                condition: service_completed_successfully
            {{- end }}
            scirius: #we need to wait for scirius to populate the static files
                condition: service_healthy
        ports:
        	{{- if .Values.nginx.ssl.enabled }}
            - 443:443
            {{- end }}
            - 80:80
        networks:
            network:
